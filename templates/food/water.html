{% extends "base.html" %}

{% block title %}Water Management - Food & Nutrition{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row">
        <div class="col-12 text-center mb-5">
            <h1 class="display-4 mb-3">
                üíß <i class="fas fa-tint me-3"></i>
                Smart Water Management System
            </h1>
            <p class="lead">AI-powered irrigation scheduling and water optimization for sustainable farming</p>
            <button class="btn btn-outline-primary" onclick="speakText('Smart water management system for farmers. Enter your crop details and location to get personalized irrigation schedules and water conservation recommendations.')">
                <i class="fas fa-volume-up me-2"></i>
                Water Guide
            </button>
        </div>
    </div>

    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card water-management-card">
                <div class="card-body p-4">
                    <div class="text-center mb-4">
                        <div class="water-icon">
                            <i class="fas fa-tint fa-3x text-primary"></i>
                        </div>
                        <h4 class="mt-3 text-primary">Water Management Planning</h4>
                        <p class="text-muted">Get AI-powered irrigation recommendations based on your crops and location</p>
                    </div>

                    <form id="waterManagementForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="water-input-group mb-3">
                                    <i class="fas fa-seedling"></i>
                                    <select class="form-select" id="crop" name="crop" required>
                                        <option value="">Select Crop Type</option>
                                        <option value="wheat">Wheat</option>
                                        <option value="rice">Rice</option>
                                        <option value="maize">Maize/Corn</option>
                                        <option value="cotton">Cotton</option>
                                        <option value="sugarcane">Sugarcane</option>
                                        <option value="soybean">Soybean</option>
                                        <option value="potato">Potato</option>
                                        <option value="tomato">Tomato</option>
                                        <option value="onion">Onion</option>
                                        <option value="cabbage">Cabbage</option>
                                        <option value="carrot">Carrot</option>
                                        <option value="spinach">Spinach</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="water-input-group mb-3">
                                    <i class="fas fa-mountain"></i>
                                    <select class="form-select" id="soilType" name="soil_type" required>
                                        <option value="">Select Soil Type</option>
                                        <option value="clayey">Clayey Soil</option>
                                        <option value="sandy">Sandy Soil</option>
                                        <option value="loamy">Loamy Soil</option>
                                        <option value="black">Black Cotton Soil</option>
                                        <option value="red">Red Soil</option>
                                        <option value="alluvial">Alluvial Soil</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="water-input-group mb-3">
                                    <i class="fas fa-ruler-combined"></i>
                                    <input type="number" class="form-control" id="fieldSize" name="field_size" 
                                           placeholder="Field Size (acres)" step="0.1" min="0.1" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="water-input-group mb-3">
                                    <i class="fas fa-calendar-alt"></i>
                                    <select class="form-select" id="season" name="season" required>
                                        <option value="">Select Season</option>
                                        <option value="kharif">Kharif (Monsoon Season)</option>
                                        <option value="rabi">Rabi (Winter Season)</option>
                                        <option value="zaid">Zaid (Summer Season)</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-12">
                                <div class="water-input-group mb-3">
                                    <i class="fas fa-map-marker-alt"></i>
                                    <input type="text" class="form-control" id="location" name="location" 
                                           placeholder="Location (e.g., Delhi, Punjab, Maharashtra)" required>
                                </div>
                            </div>
                        </div>

                        <div class="text-center">
                            <button type="submit" class="btn btn-water btn-lg px-5">
                                <i class="fas fa-chart-line me-2"></i>
                                Generate Water Management Plan
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Results Section -->
            <div id="waterPlanResults" class="card mt-4" style="display: none;">
                <div class="card-body">
                    <h5 class="card-title text-primary">
                        <i class="fas fa-tint me-2"></i>
                        Your Water Management Plan
                    </h5>
                    <div id="planContent" class="plan-result">
                        <!-- Plan content will be loaded here -->
                    </div>
                    
                    <div class="text-center mt-4">
                        <button class="btn btn-outline-primary me-2" onclick="downloadPlan()">
                            <i class="fas fa-download me-1"></i> Download Plan
                        </button>
                        <button class="btn btn-outline-secondary" onclick="printPlan()">
                            <i class="fas fa-print me-1"></i> Print Plan
                        </button>
                    </div>
                </div>
            </div>

            <!-- Loading Spinner -->
            <div id="loadingSpinner" class="text-center py-5" style="display: none;">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-3">Generating your personalized water management plan...</p>
            </div>
        </div>
        
        <!-- Sidebar with water conservation tips -->
        <div class="col-lg-4">
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-lightbulb me-2"></i>
                        Water Conservation Tips
                    </h6>
                </div>
                <div class="card-body">
                    <div class="conservation-tips">
                        <div class="tip-item mb-3">
                            <i class="fas fa-clock text-primary me-2"></i>
                            <strong>Optimal Timing:</strong> Water crops early morning or late evening to reduce evaporation
                        </div>
                        <div class="tip-item mb-3">
                            <i class="fas fa-layer-group text-success me-2"></i>
                            <strong>Mulching:</strong> Apply organic mulch to retain soil moisture and reduce water needs
                        </div>
                        <div class="tip-item mb-3">
                            <i class="fas fa-tint text-info me-2"></i>
                            <strong>Drip Irrigation:</strong> Use drip systems for 40-60% water savings compared to flood irrigation
                        </div>
                        <div class="tip-item mb-3">
                            <i class="fas fa-thermometer-half text-warning me-2"></i>
                            <strong>Soil Moisture:</strong> Check soil moisture before watering to avoid over-irrigation
                        </div>
                        <div class="tip-item mb-3">
                            <i class="fas fa-cloud-rain text-secondary me-2"></i>
                            <strong>Rainwater:</strong> Collect and store rainwater for irrigation during dry periods
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-tools me-2"></i>
                        Irrigation Methods
                    </h6>
                </div>
                <div class="card-body">
                    <div class="irrigation-methods">
                        <div class="method-item mb-3 p-3 bg-light rounded">
                            <h6 class="text-primary">üíß Drip Irrigation</h6>
                            <small>Most efficient: 90-95% water efficiency</small>
                            <div class="progress mt-2">
                                <div class="progress-bar bg-primary" style="width: 95%"></div>
                            </div>
                        </div>
                        <div class="method-item mb-3 p-3 bg-light rounded">
                            <h6 class="text-success">üåßÔ∏è Sprinkler System</h6>
                            <small>Good efficiency: 75-85% water efficiency</small>
                            <div class="progress mt-2">
                                <div class="progress-bar bg-success" style="width: 80%"></div>
                            </div>
                        </div>
                        <div class="method-item mb-3 p-3 bg-light rounded">
                            <h6 class="text-warning">üåä Flood Irrigation</h6>
                            <small>Lower efficiency: 40-60% water efficiency</small>
                            <div class="progress mt-2">
                                <div class="progress-bar bg-warning" style="width: 50%"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.water-management-card {
    border-radius: 20px;
    box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
    border: none;
}

.water-icon {
    width: 80px;
    height: 80px;
    background: linear-gradient(135deg, #007bff, #0056b3);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    margin: 0 auto;
}

.water-input-group {
    position: relative;
}

.water-input-group i {
    position: absolute;
    top: 50%;
    left: 15px;
    transform: translateY(-50%);
    color: #007bff;
    z-index: 10;
}

.water-input-group input,
.water-input-group select {
    padding-left: 45px;
    border: 2px solid #e3f2fd;
    border-radius: 10px;
    transition: all 0.3s ease;
}

.water-input-group input:focus,
.water-input-group select:focus {
    border-color: #007bff;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
}

.btn-water {
    background: linear-gradient(135deg, #007bff, #28a745);
    border: none;
    border-radius: 10px;
    color: white;
    font-weight: 600;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(0, 123, 255, 0.3);
}

.btn-water:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0, 123, 255, 0.4);
    color: white;
}

.plan-result {
    background: linear-gradient(135deg, #f8f9fa, #e9ecef);
    border-radius: 15px;
    padding: 25px;
    border-left: 5px solid #007bff;
    color: #333;
}

.plan-result * {
    color: #333;
}

.tip-item {
    padding: 10px;
    border-left: 3px solid #e9ecef;
    transition: all 0.3s ease;
}

.tip-item:hover {
    border-left-color: #007bff;
    background: rgba(0, 123, 255, 0.05);
}

.method-item {
    transition: transform 0.3s ease;
}

.method-item:hover {
    transform: translateY(-2px);
}

.progress {
    height: 8px;
}
</style>

<script>
let currentPlan = null;

document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('waterManagementForm');
    const loadingSpinner = document.getElementById('loadingSpinner');
    const resultsDiv = document.getElementById('waterPlanResults');
    const planContent = document.getElementById('planContent');
    
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Show loading
        loadingSpinner.style.display = 'block';
        resultsDiv.style.display = 'none';
        
        // Get form data
        const formData = new FormData(form);
        const waterData = Object.fromEntries(formData.entries());
        
        // Send request
        fetch('/food/api/water-management', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(waterData)
        })
        .then(response => response.json())
        .then(data => {
            loadingSpinner.style.display = 'none';
            
            if (data.success) {
                currentPlan = data.plan;
                displayWaterPlan(data.plan);
                resultsDiv.style.display = 'block';
                resultsDiv.scrollIntoView({ behavior: 'smooth' });
            } else {
                alert('Error generating water management plan: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            loadingSpinner.style.display = 'none';
            console.error('Error:', error);
            alert('Failed to generate water management plan. Please try again.');
        });
    });
});

function displayWaterPlan(plan) {
    const planContent = document.getElementById('planContent');
    
    const formattedPlan = formatPlanText(plan.recommendations || plan);
    
    planContent.innerHTML = `
        <div class="mb-4">
            <h6 class="text-primary border-bottom pb-2">
                <i class="fas fa-clipboard-list me-2"></i>
                Water Management Recommendations
            </h6>
            <div style="white-space: pre-wrap; line-height: 1.6; font-size: 0.95rem;">
                ${formattedPlan}
            </div>
        </div>
    `;
}

function formatPlanText(text) {
    return text
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.*?)\*/g, '<em>$1</em>')
        .replace(/\n/g, '<br>');
}

function downloadPlan() {
    if (!currentPlan) return;
    
    const planText = currentPlan.recommendations || currentPlan;
    const blob = new Blob([planText], { type: 'text/plain' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'water-management-plan.txt';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
}

function printPlan() {
    if (!currentPlan) return;
    
    const printWindow = window.open('', '', 'height=600,width=800');
    printWindow.document.write('<html><head><title>Water Management Plan</title>');
    printWindow.document.write('<style>body{font-family:Arial,sans-serif;margin:20px;line-height:1.6;}</style>');
    printWindow.document.write('</head><body>');
    printWindow.document.write('<h2>üåä Water Management Plan</h2>');
    printWindow.document.write('<pre>' + (currentPlan.recommendations || currentPlan) + '</pre>');
    printWindow.document.write('<hr><small>Generated by Community Empowerment Platform - Food & Nutrition Module</small>');
    printWindow.document.write('</body></html>');
    printWindow.document.close();
    printWindow.print();
}
</script>
{% endblock %}