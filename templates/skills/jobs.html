{% extends "base.html" %}

{% block title %}Jobs - Skills & Employment{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h2">
            <i class="fas fa-briefcase me-2"></i>
            Job Opportunities
        </h1>
        <div class="d-flex gap-2">
            <button class="btn btn-outline-primary" onclick="speakText('Job opportunities page. Browse available positions or post your own job listing.')">
                <i class="fas fa-volume-up me-2"></i>
                Page Guide
            </button>
            <button class="btn btn-primary" onclick="showJobForm()">
                <i class="fas fa-plus me-2"></i>
                Post Job
            </button>
        </div>
    </div>

    <!-- Job Filters -->
    <div class="card mb-4">
        <div class="card-body">
            <h6 class="card-title mb-3">Filter Jobs</h6>
            <div class="row g-3">
                <div class="col-md-3">
                    <select class="form-select" id="locationFilter" onchange="filterJobs()">
                        <option value="">All Locations</option>
                        <option value="remote">Remote Only</option>
                        <option value="local">Local Only</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <select class="form-select" id="categoryFilter" onchange="filterJobs()">
                        <option value="">All Categories</option>
                        <option value="technical">Technical</option>
                        <option value="healthcare">Healthcare</option>
                        <option value="education">Education</option>
                        <option value="agriculture">Agriculture</option>
                        <option value="retail">Retail</option>
                        <option value="service">Service</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <input type="text" class="form-control" id="skillsFilter" placeholder="Required skills..." onkeyup="filterJobs()">
                </div>
                <div class="col-md-3">
                    <button class="btn btn-outline-secondary w-100" onclick="clearFilters()">
                        <i class="fas fa-times me-2"></i>Clear Filters
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Job Listings -->
    <div class="row g-4" id="jobListings">
        {% if jobs %}
        {% for job in jobs %}
        <div class="col-lg-6 job-item" data-location="{{ 'remote' if job.is_remote else 'local' }}" data-skills="{{ job.skills_required or '' }}">
            <div class="card h-100 job-card-detailed">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h5 class="card-title mb-1">{{ job.title }}</h5>
                            <p class="text-muted mb-0">{{ job.company }}</p>
                        </div>
                        {% if job.is_remote %}
                        <span class="badge bg-success">Remote</span>
                        {% endif %}
                    </div>
                </div>
                <div class="card-body">
                    <p class="card-text">{{ job.description }}</p>
                    
                    <div class="job-details mb-3">
                        {% if not job.is_remote and job.location %}
                        <div class="detail-item">
                            <i class="fas fa-map-marker-alt text-muted me-2"></i>
                            <span>{{ job.location }}</span>
                        </div>
                        {% endif %}
                        
                        {% if job.salary_range %}
                        <div class="detail-item">
                            <i class="fas fa-dollar-sign text-muted me-2"></i>
                            <span>{{ job.salary_range }}</span>
                        </div>
                        {% endif %}
                        
                        {% if job.skills_required %}
                        <div class="detail-item">
                            <i class="fas fa-tools text-muted me-2"></i>
                            <span>{{ job.skills_required }}</span>
                        </div>
                        {% endif %}
                        
                        <div class="detail-item">
                            <i class="fas fa-calendar text-muted me-2"></i>
                            <span>Posted {{ job.created_at.strftime('%B %d, %Y') }}</span>
                        </div>
                    </div>
                </div>
                <div class="card-footer bg-transparent">
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-primary btn-sm" onclick="matchJobToSkills('{{ job.title }}', '{{ job.description }}', {{ job.id }})">
                            <i class="fas fa-brain me-1"></i>
                            AI Match
                        </button>
                        {% if job.contact_info %}
                        <button class="btn btn-primary btn-sm flex-grow-1" onclick="applyToJob('{{ job.contact_info }}', '{{ job.title }}', '{{ job.company }}')">
                            <i class="fas fa-paper-plane me-1"></i>
                            Apply Now
                        </button>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
        {% else %}
        <div class="col-12">
            <div class="empty-state text-center py-5">
                <i class="fas fa-briefcase fa-4x text-muted mb-4"></i>
                <h4>No Jobs Available</h4>
                <p class="text-muted mb-4">Be the first to post a job opportunity for the community!</p>
                <button class="btn btn-primary btn-lg" onclick="showJobForm()">
                    <i class="fas fa-plus me-2"></i>
                    Post the First Job
                </button>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- No Results Message -->
    <div id="noResults" class="text-center py-5" style="display: none;">
        <i class="fas fa-search fa-3x text-muted mb-3"></i>
        <h5>No Jobs Match Your Criteria</h5>
        <p class="text-muted">Try adjusting your filters or check back later for new opportunities.</p>
        <button class="btn btn-outline-primary" onclick="clearFilters()">
            Clear All Filters
        </button>
    </div>
</div>

<!-- Job Posting Modal -->
<div class="modal fade" id="jobModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-plus me-2"></i>
                    Post a Job Opportunity
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="jobForm" onsubmit="submitJob(event)">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="mb-3">
                                <label for="jobTitle" class="form-label">Job Title *</label>
                                <input type="text" class="form-control" id="jobTitle" name="title" required>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="company" class="form-label">Company/Organization *</label>
                                <input type="text" class="form-control" id="company" name="company" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="jobDescription" class="form-label">Job Description *</label>
                        <textarea class="form-control" id="jobDescription" name="description" rows="4" required placeholder="Describe the role, responsibilities, and requirements..."></textarea>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="jobLocation" class="form-label">Location</label>
                                <input type="text" class="form-control" id="jobLocation" name="location" placeholder="City, State">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="salaryRange" class="form-label">Salary Range</label>
                                <input type="text" class="form-control" id="salaryRange" name="salary_range" placeholder="e.g., $15-20/hour, $40,000-50,000/year">
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="skillsRequired" class="form-label">Required Skills</label>
                        <input type="text" class="form-control" id="skillsRequired" name="skills_required" placeholder="e.g., Customer service, Computer skills, Spanish fluency">
                    </div>
                    
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="isRemoteJob" name="is_remote">
                        <label class="form-check-label" for="isRemoteJob">
                            This is a remote position
                        </label>
                    </div>
                    
                    <div class="mb-3">
                        <label for="jobContact" class="form-label">Contact Information *</label>
                        <input type="text" class="form-control" id="jobContact" name="contact_info" required placeholder="Email address or phone number">
                        <div class="form-text">This will be used by applicants to contact you.</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-plus me-2"></i>
                        Post Job
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Job Matching Modal -->
<div class="modal fade" id="jobMatchModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-brain me-2"></i>
                    AI Job Matching Analysis
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="jobMatchContent">
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary mb-3" role="status"></div>
                        <p>Analyzing job requirements and your skills...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <a href="{{ url_for('skills.learning') }}" class="btn btn-primary">
                    <i class="fas fa-graduation-cap me-2"></i>
                    Start Learning
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function showJobForm() {
    const jobModal = new bootstrap.Modal(document.getElementById('jobModal'));
    jobModal.show();
}

function submitJob(event) {
    event.preventDefault();
    
    const formData = new FormData(event.target);
    const jobData = Object.fromEntries(formData.entries());
    jobData.is_remote = document.getElementById('isRemoteJob').checked;
    
    fetch('/skills/post-job', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(jobData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            speakText('Job posted successfully! Your listing will help connect community members with employment opportunities.');
            bootstrap.Modal.getInstance(document.getElementById('jobModal')).hide();
            location.reload();
        } else {
            alert('Error posting job: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error posting job. Please try again.');
    });
}

function filterJobs() {
    const locationFilter = document.getElementById('locationFilter').value;
    const categoryFilter = document.getElementById('categoryFilter').value;
    const skillsFilter = document.getElementById('skillsFilter').value.toLowerCase();
    
    const jobItems = document.querySelectorAll('.job-item');
    let visibleCount = 0;
    
    jobItems.forEach(item => {
        let show = true;
        
        // Location filter
        if (locationFilter && item.dataset.location !== locationFilter) {
            show = false;
        }
        
        // Skills filter
        if (skillsFilter && !item.dataset.skills.toLowerCase().includes(skillsFilter)) {
            show = false;
        }
        
        // Category filter (would need to be added to job data)
        if (categoryFilter) {
            // For now, show all as we don't have categories in the model
        }
        
        item.style.display = show ? 'block' : 'none';
        if (show) visibleCount++;
    });
    
    // Show/hide no results message
    document.getElementById('noResults').style.display = visibleCount === 0 ? 'block' : 'none';
}

function clearFilters() {
    document.getElementById('locationFilter').value = '';
    document.getElementById('categoryFilter').value = '';
    document.getElementById('skillsFilter').value = '';
    
    document.querySelectorAll('.job-item').forEach(item => {
        item.style.display = 'block';
    });
    
    document.getElementById('noResults').style.display = 'none';
}

function matchJobToSkills(jobTitle, jobDescription, jobId) {
    const skills = prompt('Enter your skills (comma-separated) to see how well you match this job:');
    if (!skills) return;
    
    const skillsList = skills.split(',').map(s => s.trim());
    
    const jobMatchModal = new bootstrap.Modal(document.getElementById('jobMatchModal'));
    jobMatchModal.show();
    
    fetch('/skills/api/job-match', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            job_description: `${jobTitle}: ${jobDescription}`,
            skills: skillsList
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            displayJobMatch(data, jobTitle);
            const matchText = `Job match analysis complete. Your match score is ${Math.round(data.match_score * 100)}%.`;
            speakText(matchText);
        } else {
            document.getElementById('jobMatchContent').innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Unable to analyze job match: ${data.error}
                </div>
            `;
        }
    })
    .catch(error => {
        console.error('Job match error:', error);
        document.getElementById('jobMatchContent').innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-times me-2"></i>
                Error analyzing job match. Please try again.
            </div>
        `;
    });
}

function displayJobMatch(matchData, jobTitle) {
    const matchScore = Math.round(matchData.match_score * 100);
    const scoreColor = matchScore >= 80 ? 'success' : matchScore >= 60 ? 'warning' : 'danger';
    const scoreIcon = matchScore >= 80 ? 'check-circle' : matchScore >= 60 ? 'exclamation-circle' : 'times-circle';
    
    document.getElementById('jobMatchContent').innerHTML = `
        <div class="job-match-analysis">
            <div class="text-center mb-4">
                <i class="fas fa-${scoreIcon} fa-3x text-${scoreColor} mb-3"></i>
                <h4>${matchScore}% Match</h4>
                <p class="text-muted">for ${jobTitle}</p>
            </div>
            
            <div class="match-breakdown">
                <div class="progress mb-4">
                    <div class="progress-bar bg-${scoreColor}" style="width: ${matchScore}%"></div>
                </div>
                
                <div class="row g-4">
                    <div class="col-md-6">
                        <div class="match-section">
                            <h6 class="text-success">
                                <i class="fas fa-check-circle me-2"></i>
                                Your Strengths
                            </h6>
                            <ul class="list-unstyled">
                                ${matchData.reasons.map(reason => `
                                    <li class="mb-2">
                                        <i class="fas fa-plus text-success me-2"></i>
                                        ${reason}
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="match-section">
                            <h6 class="text-warning">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                Areas to Develop
                            </h6>
                            <ul class="list-unstyled">
                                ${matchData.skill_gaps.map(gap => `
                                    <li class="mb-2">
                                        <i class="fas fa-arrow-up text-warning me-2"></i>
                                        ${gap}
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                    </div>
                </div>
                
                <div class="recommendations mt-4">
                    <h6 class="text-info">
                        <i class="fas fa-lightbulb me-2"></i>
                        Recommendations
                    </h6>
                    <div class="alert alert-info">
                        <ul class="mb-0">
                            ${matchData.recommendations.map(rec => `
                                <li>${rec}</li>
                            `).join('')}
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    `;
}

function applyToJob(contactInfo, jobTitle, company) {
    speakText(`Applying to ${jobTitle} at ${company}. Contact information: ${contactInfo}`);
    
    if (contactInfo.includes('@')) {
        // Email application
        const subject = `Application for ${jobTitle} position`;
        const body = `Dear Hiring Manager,\n\nI am interested in applying for the ${jobTitle} position at ${company} that I found on the Community Empowerment Platform.\n\nI would appreciate the opportunity to discuss how my skills and experience can contribute to your team.\n\nThank you for your consideration.\n\nBest regards`;
        
        window.location.href = `mailto:${contactInfo}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
    } else {
        // Phone contact
        const userEmail = prompt('Enter your email address to send your contact information:');
        if (userEmail) {
            alert(`Thank you! Contact ${contactInfo} directly and mention you found this position on the Community Platform. Your email: ${userEmail}`);
        }
    }
}

// Voice command handling for jobs page
function handleJobsVoiceCommand(command) {
    const lowerCommand = command.toLowerCase();
    
    if (lowerCommand.includes('post job') || lowerCommand.includes('add job')) {
        showJobForm();
        speakText('Opening job posting form. Please fill in the details for your job opportunity.');
    } else if (lowerCommand.includes('filter') || lowerCommand.includes('search')) {
        document.getElementById('skillsFilter').focus();
        speakText('You can now type or speak to filter jobs by skills.');
    } else if (lowerCommand.includes('clear') || lowerCommand.includes('reset')) {
        clearFilters();
        speakText('All filters cleared. Showing all available jobs.');
    }
}

// Set up voice command handling
if (typeof window.globalVoiceHandler !== 'undefined') {
    window.globalVoiceHandler = handleJobsVoiceCommand;
}
</script>
{% endblock %}
